name: CI/CD Pipeline (Self-hosted Runner)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: -Xmx2g

jobs:
  build-and-deploy:
    runs-on: self-hosted  # ä½¿ç”¨ Self-hosted Runner

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: false  # ä¿ç•™å·¥ä½œç›®å½•ï¼ŒåŠ å¿«é€Ÿåº¦

#      # 2. è®¾ç½® Java ç¯å¢ƒ (å¦‚æœæœåŠ¡å™¨å·²æœ‰ Java å¯ä»¥è·³è¿‡)
#      - name: Set up JDK 17
#        uses: actions/setup-java@v4
#        with:
#          java-version: ${{ env.JAVA_VERSION }}
#          distribution: 'temurin'
#          cache: 'maven'
#
#      # 3. Maven æ„å»º
#      - name: Build with Maven
#        run: |
#          echo "ğŸ—ï¸  Building project with Maven..."
#          mvn clean package -DskipTests
#          echo "âœ… Build completed successfully"

      # 4. è¿è¡Œæµ‹è¯• (å¯é€‰)
      # - name: Run tests
      #   run: mvn test

      # 5. æ£€æŸ¥ .env æ–‡ä»¶
      - name: Check environment file
        run: |
          if [ ! -f .env ]; then
            echo "âŒ Error: .env file not found!"
            echo "Please create .env file on the server:"
            echo "  cp .env.example .env"
            echo "  vim .env"
            exit 1
          fi
          echo "âœ… .env file found"

      # 6. æ„å»º Docker é•œåƒ
      - name: Build Docker image
        run: |
          echo "ğŸ³ Building Docker image..."
          docker-compose build
          echo "âœ… Docker image built successfully"

      # 7. åœæ­¢æ—§å®¹å™¨
      - name: Stop old containers
        run: |
          echo "ğŸ›‘ Stopping old containers..."
          docker-compose down || echo "No containers to stop"
          echo "âœ… Old containers stopped"

      # 8. å¯åŠ¨æ–°å®¹å™¨
      - name: Start new containers
        run: |
          echo "ğŸš€ Starting new containers..."
          docker-compose up -d
          echo "âœ… New containers started"

      # 9. ç­‰å¾…æœåŠ¡å¯åŠ¨
      - name: Wait for service to start
        run: |
          echo "â³ Waiting for service to start (30 seconds)..."
          sleep 30

      # 10. å¥åº·æ£€æŸ¥
      - name: Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if docker-compose ps | grep -q "sky-server.*Up"; then
            echo "âœ… Container is running"
            docker-compose ps
            
            # æ£€æŸ¥åº”ç”¨å¥åº·ç«¯ç‚¹ (å¦‚æœæœ‰)
            if command -v curl &> /dev/null; then
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
              if [ "$HTTP_CODE" == "200" ]; then
                echo "âœ… Application is healthy (HTTP $HTTP_CODE)"
              else
                echo "âš ï¸  Application health check returned HTTP $HTTP_CODE"
              fi
            fi
          else
            echo "âŒ Container is not running!"
            echo "Container status:"
            docker-compose ps
            echo "Recent logs:"
            docker-compose logs --tail=50
            exit 1
          fi

      # 11. æ¸…ç†æ—§é•œåƒ
      - name: Clean up old images
        run: |
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f
          echo "âœ… Cleanup completed"

      # 12. æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      - name: Deployment summary
        if: success()
        run: |
          echo "========================================="
          echo "  âœ… Deployment completed successfully!"
          echo "========================================="
          echo ""
          echo "ğŸ“Š Container Status:"
          docker-compose ps
          echo ""
          echo "ğŸ“ Recent Logs:"
          docker-compose logs --tail=20
          echo ""
          echo "ğŸŒ Service URLs:"
          echo "  - API: http://localhost:8080"
          echo "  - Swagger: http://localhost:8080/doc.html"
          echo "  - Metrics: http://localhost:8080/actuator/prometheus"

      # 13. å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
      - name: Show logs on failure
        if: failure()
        run: |
          echo "========================================="
          echo "  âŒ Deployment failed!"
          echo "========================================="
          echo ""
          echo "ğŸ“Š Container Status:"
          docker-compose ps
          echo ""
          echo "ğŸ“ Full Logs:"
          docker-compose logs --tail=100

